# HyperLiquid API 使用说明

## 📋 API 集成状态

### ✅ 已实现的 API

1. **获取用户成交记录** (`userFills` / `userFillsByTime`)
   - ✅ 支持获取最近2000条记录
   - ✅ 支持按时间范围查询
   - ✅ 自动处理分页（最多10000条）

2. **获取账户价值历史** (`portfolio`)
   - ✅ 获取账户价值历史
   - ✅ 获取盈亏历史
   - ✅ 支持多个时间范围

3. **获取当前挂单** (`openOrders`)
   - ✅ 获取当前挂单列表

### ⚠️ 限制说明

1. **存款/取款记录**
   - ❌ API 不提供存款/取款记录
   - 💡 解决方案：
     - 使用账户价值历史估算初始资金
     - 或集成链上数据查询（需要额外开发）

2. **当前持仓**
   - ⚠️ API 不直接提供持仓信息
   - 💡 解决方案：
     - 通过分析成交记录计算持仓
     - 或通过挂单推断（不准确）

3. **数据量限制**
   - ⚠️ 成交记录最多10000条可用
   - ⚠️ 每次查询最多2000条
   - 💡 已实现自动分页处理

## 🔧 配置说明

### 切换 Mock / 真实 API

编辑 `backend/data/config/system.json`：

```json
{
  "api": {
    "base_url": "https://api.hyperliquid.xyz/info",
    "timeout": 30,
    "retry_times": 3,
    "retry_delay": 1,
    "use_mock": false  // false = 使用真实 API，true = 使用 Mock 数据
  }
}
```

### 首次使用真实 API

1. **修改配置**：
   ```bash
   # 编辑配置文件
   vim backend/data/config/system.json
   # 将 "use_mock" 改为 false
   ```

2. **重启服务**：
   ```bash
   ./stop.sh
   ./start.sh
   ```

3. **测试导入**：
   - 访问 http://localhost:5173
   - 导入一个钱包地址
   - 查看是否获取到真实数据

## 📊 数据映射说明

### API 数据 → 系统数据格式

#### 成交记录 (Fills)
```json
// API 返回格式
{
  "coin": "BTC",
  "px": "50000.0",
  "sz": "1.5",
  "side": "B",
  "time": 1681222254710,
  "closedPnl": "100.0",
  "fee": "0.01",
  "hash": "0x..."
}

// 转换为系统格式
{
  "timestamp": 1681222254,  // 秒级时间戳
  "symbol": "BTC",
  "side": "long",  // B = long, A = short
  "size": 1.5,
  "entry_price": 50000.0,
  "exit_price": 50000.0,
  "pnl": 100.0,
  "fees": 0.01,
  "hash": "0x..."
}
```

#### 账户价值历史 (Portfolio)
```json
// API 返回格式
[
  ["day", {
    "accountValueHistory": [[1681222254710, "10000.0"], ...],
    "pnlHistory": [[1681222254710, "0.0"], ...]
  }],
  ["week", {...}],
  ...
]

// 转换为收益曲线
{
  "24h": [[timestamp, value], ...],
  "7d": [[timestamp, value], ...],
  "30d": [[timestamp, value], ...],
  "all": [[timestamp, value], ...]
}
```

## 🔍 数据准确性说明

### ✅ 准确的数据
- 交易历史（成交记录）
- 账户价值历史
- 盈亏历史
- 手续费

### ⚠️ 估算的数据
- **初始资金**：通过最早的账户价值估算
- **存款/取款**：API 不提供，设为空数组
- **当前持仓**：需要额外计算

### 💡 提高准确性的建议

1. **初始资金**：
   - 如果知道初始资金，可以手动设置
   - 或通过账户价值历史的最早值估算

2. **持仓信息**：
   - 可以通过分析成交记录计算
   - 需要跟踪每笔交易的开仓/平仓

3. **存款/取款**：
   - 需要集成链上数据查询
   - 或让用户手动输入

## 🐛 常见问题

### 1. API 返回空数据

**可能原因**：
- 钱包地址不正确
- 钱包没有交易记录
- API 限流

**解决方案**：
- 检查钱包地址格式（42字符，0x开头）
- 确认钱包有交易记录
- 查看日志文件

### 2. 数据不完整

**可能原因**：
- 交易记录超过10000条（API限制）
- 时间范围查询失败

**解决方案**：
- 系统会自动处理分页
- 检查日志查看是否有错误

### 3. 初始资金不准确

**说明**：
- API 不提供存款记录
- 初始资金通过账户价值历史估算

**解决方案**：
- 手动设置初始资金
- 或接受估算值

## 📝 日志查看

查看 API 调用日志：
```bash
# 后端日志
tail -f logs/backend.log

# 应用日志
tail -f backend/logs/app.log

# API 日志
tail -f backend/logs/api.log
```

## 🚀 下一步

1. **测试真实 API**：
   - 修改配置 `use_mock: false`
   - 导入一个真实钱包地址
   - 查看数据是否正确

2. **优化数据处理**：
   - 完善持仓计算逻辑
   - 优化初始资金估算

3. **扩展功能**（可选）：
   - 集成链上数据查询
   - 添加存款/取款记录查询

---

**当前版本已支持真实 API 调用！** 🎉

