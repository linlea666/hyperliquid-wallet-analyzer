# V2.0 完整架构设计

## 🏗️ 整体架构

### 系统分层

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (Frontend)                      │
│  Vue 3 + Vite + Element Plus + TypeScript               │
│  - 管理后台                                              │
│  - 数据看板                                              │
│  - 实时进度显示                                          │
└─────────────────────────────────────────────────────────┘
                            ↓ HTTP/WebSocket
┌─────────────────────────────────────────────────────────┐
│                    API 网关层 (Gateway)                   │
│  - 认证中间件                                            │
│  - 权限验证                                              │
│  - 请求日志                                              │
│  - 限流控制                                              │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Business)                   │
│  - 钱包分析服务                                          │
│  - 评分计算服务                                          │
│  - 标签管理服务                                          │
│  - 导入管理服务                                          │
│  - AI 分析服务                                           │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   数据访问层 (Data Access)                │
│  - 数据库操作                                            │
│  - 缓存管理                                              │
│  - 外部 API 调用                                         │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    数据存储层 (Storage)                   │
│  - SQLite 数据库                                         │
│  - Redis 缓存 (可选)                                     │
│  - 文件存储                                              │
└─────────────────────────────────────────────────────────┘
```

## 🔐 认证与权限系统

### 用户角色设计

```python
class UserRole:
    ADMIN = "admin"          # 管理员：完全权限
    OPERATOR = "operator"    # 操作员：只读 + 部分操作
    VIEWER = "viewer"        # 访客：只读
```

### 权限矩阵

| 功能模块 | 管理员 | 操作员 | 访客 |
|---------|--------|--------|------|
| 查看钱包列表 | ✅ | ✅ | ✅ |
| 查看钱包详情 | ✅ | ✅ | ✅ |
| 添加钱包 | ✅ | ✅ | ❌ |
| 删除钱包 | ✅ | ❌ | ❌ |
| 批量导入 | ✅ | ✅ | ❌ |
| 修改标签 | ✅ | ✅ | ❌ |
| 系统配置 | ✅ | ❌ | ❌ |
| 用户管理 | ✅ | ❌ | ❌ |
| 修改密码 | ✅ | ✅ | ✅ |

### 认证流程

```
1. 用户登录
   ↓
2. 验证用户名密码
   ↓
3. 生成 JWT Token
   - access_token (30分钟)
   - refresh_token (7天)
   ↓
4. 返回 Token
   ↓
5. 前端存储 Token
   ↓
6. 每次请求携带 Token
   ↓
7. 后端验证 Token
   - 验证签名
   - 检查过期
   - 提取用户信息
   ↓
8. 权限检查
   ↓
9. 执行业务逻辑
```

### 默认账户

```python
默认管理员账户:
- 用户名: admin
- 密码: admin888
- 角色: admin
- 首次登录: 强制修改密码
```

## 🌐 API 设计规范

### 统一响应格式

```json
成功响应:
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {...},
  "timestamp": "2025-11-22T10:30:00Z"
}

错误响应:
{
  "success": false,
  "code": 400,
  "message": "错误描述",
  "error": "详细错误信息",
  "timestamp": "2025-11-22T10:30:00Z"
}
```

### HTTP 状态码规范

```
200 OK              - 成功
201 Created         - 创建成功
400 Bad Request     - 请求参数错误
401 Unauthorized    - 未认证
403 Forbidden       - 无权限
404 Not Found       - 资源不存在
409 Conflict        - 资源冲突
429 Too Many Requests - 请求过多
500 Internal Error  - 服务器错误
```

### API 路由规范

```
认证相关:
POST   /api/auth/login          # 登录
POST   /api/auth/logout         # 登出
POST   /api/auth/refresh        # 刷新 Token
POST   /api/auth/change-password # 修改密码
GET    /api/auth/me             # 获取当前用户信息

用户管理:
GET    /api/users               # 获取用户列表
POST   /api/users               # 创建用户
GET    /api/users/{id}          # 获取用户详情
PUT    /api/users/{id}          # 更新用户
DELETE /api/users/{id}          # 删除用户

钱包管理:
GET    /api/wallets             # 获取钱包列表
POST   /api/wallets             # 添加钱包
GET    /api/wallets/{address}   # 获取钱包详情
DELETE /api/wallets/{address}   # 删除钱包

批量导入:
POST   /api/import/create-task  # 创建导入任务
GET    /api/import/tasks        # 获取任务列表
GET    /api/import/task/{id}    # 获取任务进度
POST   /api/import/task/{id}/cancel # 取消任务

标签管理:
GET    /api/tags                # 获取所有标签
POST   /api/tags                # 添加标签
DELETE /api/tags/{id}           # 删除标签
GET    /api/tags/popular        # 热门标签

系统配置:
GET    /api/config              # 获取配置
PUT    /api/config              # 更新配置
GET    /api/config/scoring      # 评分配置
PUT    /api/config/scoring      # 更新评分配置

榜单管理:
GET    /api/leaderboards        # 获取榜单列表
GET    /api/leaderboards/{name} # 获取榜单数据
POST   /api/leaderboards        # 创建自定义榜单
PUT    /api/leaderboards/{id}   # 更新榜单
DELETE /api/leaderboards/{id}   # 删除榜单
```

## 📡 WebSocket 实时通信

### 连接管理

```python
WebSocket 端点:
ws://localhost:8000/ws/{token}

消息格式:
{
  "type": "progress",        # 消息类型
  "task_id": "uuid-xxx",     # 任务ID
  "data": {...}              # 数据
}

消息类型:
- progress: 进度更新
- notification: 系统通知
- wallet_update: 钱包更新
- error: 错误信息
```

### 进度推送

```json
{
  "type": "progress",
  "task_id": "uuid-xxx",
  "data": {
    "status": "processing",
    "progress": 45.5,
    "processed": 455,
    "total": 1000,
    "success": 430,
    "failed": 15,
    "skipped": 10,
    "eta": 180,
    "current_batch": 10,
    "total_batches": 20,
    "current_address": "0x..."
  }
}
```

## 🎨 前端架构

### 页面结构

```
/admin                      # 管理后台
├── /login                  # 登录页
├── /dashboard              # 仪表盘
├── /wallets                # 钱包管理
│   ├── /list              # 钱包列表
│   ├── /detail/:address   # 钱包详情
│   └── /import            # 批量导入
├── /leaderboards          # 榜单
│   ├── /list              # 榜单列表
│   └── /detail/:name      # 榜单详情
├── /tags                   # 标签管理
├── /settings              # 系统设置
│   ├── /general           # 基本设置
│   ├── /scoring           # 评分配置
│   ├── /ai                # AI 配置
│   └── /users             # 用户管理
└── /profile               # 个人资料
    └── /change-password   # 修改密码
```

### 组件设计

```
公共组件:
- Layout              # 布局组件
- Header              # 顶部导航
- Sidebar             # 侧边栏
- Breadcrumb          # 面包屑
- ProgressBar         # 进度条
- WalletCard          # 钱包卡片
- TagSelector         # 标签选择器
- DataTable           # 数据表格
- Chart               # 图表组件

业务组件:
- ImportProgress      # 导入进度组件
- WalletScoreCard     # 评分卡片
- LeaderboardTable    # 榜单表格
- TagCloud            # 标签云
- ScoreGauge          # 评分仪表盘
```

### 状态管理

```typescript
// Pinia Store 结构

// auth.ts - 认证状态
{
  user: User | null,
  token: string | null,
  isAuthenticated: boolean,
  permissions: string[]
}

// wallet.ts - 钱包状态
{
  wallets: Wallet[],
  currentWallet: Wallet | null,
  loading: boolean,
  filters: FilterOptions
}

// import.ts - 导入状态
{
  tasks: ImportTask[],
  currentTask: ImportTask | null,
  progress: ProgressData
}

// tag.ts - 标签状态
{
  tags: Tag[],
  popularTags: Tag[],
  selectedTags: string[]
}

// config.ts - 配置状态
{
  systemConfig: SystemConfig,
  scoringConfig: ScoringConfig,
  aiConfig: AIConfig
}
```

## 🔄 数据流设计

### 批量导入流程（完整版）

```
前端:
1. 用户上传文件/输入地址
   ↓
2. 前端验证格式
   ↓
3. 调用 API 创建任务
   POST /api/import/create-task
   ↓
4. 建立 WebSocket 连接
   ws://localhost:8000/ws/{token}
   ↓
5. 订阅任务进度
   subscribe(task_id)
   ↓
6. 显示进度条
   - 实时更新进度
   - 显示当前处理的地址
   - 显示成功/失败数
   - 显示预计剩余时间
   ↓
7. 任务完成
   - 显示结果报告
   - 提供下载失败列表
   - 提供重试选项

后端:
1. 接收创建任务请求
   ↓
2. 验证 Token 和权限
   ↓
3. 解析地址列表
   ↓
4. 创建导入任务
   ↓
5. 返回 task_id
   ↓
6. 后台异步执行
   - 分批处理
   - 每处理一个钱包
     → 推送进度到 WebSocket
   - 批次间延迟
   ↓
7. 任务完成
   - 推送完成消息
   - 保存导入记录
   - 创建系统通知
```

### 钱包分析流程（完整版）

```
1. 接收钱包地址
   ↓
2. 检查是否已存在
   ↓
3. 调用 HyperLiquid API
   - 获取交易记录
   - 获取账户价值
   - 获取持仓信息
   - 获取资金流水
   ↓
4. 数据处理
   - 格式转换
   - 指标计算
   ↓
5. 评分计算
   - 6 大维度评分
   - 综合评分
   ↓
6. 标签生成
   - 系统标签（规则匹配）
   - AI 标签（可选）
   ↓
7. 存入数据库
   - 钱包表
   - 交易表
   - 持仓表
   - 流水表
   ↓
8. 推送更新通知
   - WebSocket 推送
   - 系统通知
```

## 🔒 安全设计

### 认证安全

```python
1. 密码加密
   - bcrypt 哈希
   - 加盐处理
   - 不可逆

2. Token 安全
   - JWT 签名
   - 短期有效（30分钟）
   - 刷新机制

3. 会话管理
   - 单点登录
   - 自动过期
   - 强制登出

4. 防暴力破解
   - 登录限流
   - 验证码（可选）
   - 账户锁定
```

### API 安全

```python
1. 认证中间件
   - 验证 Token
   - 提取用户信息

2. 权限中间件
   - 检查角色
   - 验证权限

3. 限流中间件
   - IP 限流
   - 用户限流
   - API 限流

4. CORS 配置
   - 允许的域名
   - 允许的方法
   - 允许的头部
```

### 数据安全

```python
1. 输入验证
   - 参数类型检查
   - 长度限制
   - 格式验证

2. SQL 注入防护
   - 参数化查询
   - ORM 使用

3. XSS 防护
   - 输出转义
   - CSP 策略

4. 敏感数据
   - 密码不返回
   - Token 不记录
   - 日志脱敏
```

## 📊 监控与日志

### 日志级别

```python
DEBUG   - 调试信息（开发环境）
INFO    - 一般信息（重要操作）
WARNING - 警告信息（潜在问题）
ERROR   - 错误信息（需要关注）
CRITICAL - 严重错误（需要立即处理）
```

### 日志内容

```python
操作日志:
- 用户登录/登出
- 钱包添加/删除
- 配置修改
- 批量导入

错误日志:
- API 调用失败
- 数据库错误
- 认证失败
- 权限拒绝

性能日志:
- API 响应时间
- 数据库查询时间
- 外部 API 调用时间
```

### 监控指标

```python
系统指标:
- CPU 使用率
- 内存使用率
- 磁盘使用率
- 网络流量

业务指标:
- 在线用户数
- API 调用量
- 钱包总数
- 导入任务数
- 成功率/失败率

性能指标:
- 平均响应时间
- P95/P99 响应时间
- 错误率
- 并发数
```

## 🎯 一致性保证

### 代码规范

```python
1. 命名规范
   - 类名: PascalCase
   - 函数名: snake_case
   - 常量: UPPER_CASE
   - 变量: snake_case

2. 文档规范
   - 所有函数必须有文档字符串
   - 参数说明
   - 返回值说明
   - 异常说明

3. 错误处理
   - 统一的异常类
   - 详细的错误信息
   - 合适的 HTTP 状态码

4. 日志规范
   - 统一的日志格式
   - 合适的日志级别
   - 关键操作必须记录
```

### 数据库规范

```python
1. 表命名
   - 小写字母
   - 下划线分隔
   - 复数形式

2. 字段命名
   - 小写字母
   - 下划线分隔
   - 见名知意

3. 索引命名
   - idx_{table}_{column}

4. 外键命名
   - fk_{table}_{ref_table}
```

### API 规范

```python
1. 路径命名
   - 小写字母
   - 短横线分隔
   - RESTful 风格

2. 参数命名
   - 小写字母
   - 下划线分隔
   - camelCase (前端)

3. 响应格式
   - 统一的数据结构
   - 统一的错误格式
   - 统一的时间格式 (ISO 8601)

4. 版本管理
   - /api/v1/...
   - /api/v2/...
```

## 🚀 部署架构

### 开发环境

```
本地开发:
- Python 虚拟环境
- SQLite 数据库
- 前端开发服务器 (Vite)
- 后端开发服务器 (Uvicorn)
```

### 生产环境

```
服务器部署:
- Nginx (反向代理 + 静态文件)
- Gunicorn + Uvicorn (后端服务)
- SQLite / MySQL (数据库)
- Redis (缓存，可选)
- Supervisor / PM2 (进程管理)
```

## 📋 开发优先级

### Phase 1: 基础设施（当前）
- [x] 数据库设计
- [x] 评分模型
- [x] API 集成
- [x] 批量导入
- [x] 标签系统
- [ ] **认证系统** ← 下一步
- [ ] **WebSocket** ← 下一步

### Phase 2: 管理后台
- [ ] 登录页面
- [ ] 仪表盘
- [ ] 钱包管理页面
- [ ] 导入进度页面
- [ ] 标签管理页面
- [ ] 系统设置页面

### Phase 3: 高级功能
- [ ] AI 标签集成
- [ ] 榜单系统
- [ ] 数据导出
- [ ] 报表生成

### Phase 4: 优化完善
- [ ] 性能优化
- [ ] 安全加固
- [ ] 监控告警
- [ ] 文档完善

## 🎉 总结

这个架构设计确保了：

1. **完整性**: 覆盖所有必需功能
2. **一致性**: 统一的规范和标准
3. **安全性**: 完善的认证和权限
4. **可扩展性**: 模块化设计
5. **可维护性**: 清晰的结构和文档
6. **用户体验**: 实时反馈和友好界面

下一步我将实现：
1. 用户认证系统
2. WebSocket 实时通信
3. 前端管理后台基础框架

