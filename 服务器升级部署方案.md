# 服务器升级部署方案

**日期**: 2025-11-22  
**版本**: V1.0 → V2.0  
**重要性**: 🔴 高

---

## 🎯 部署策略分析

### 方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **方案 A: 增量更新** | 快速、保留数据、风险低 | 可能有残留文件 | ⭐⭐⭐⭐⭐ |
| **方案 B: 全新部署** | 干净、无残留 | 耗时长、需要重新配置 | ⭐⭐⭐ |

---

## ✅ 推荐方案：增量更新（方案 A）

### 为什么选择增量更新？

1. **数据安全** ✅
   - 保留现有数据库
   - 保留已导入的钱包数据
   - 保留系统配置

2. **快速部署** ✅
   - 只需拉取更新
   - 安装新依赖
   - 重启服务

3. **风险可控** ✅
   - 可以随时回滚
   - 不影响现有数据
   - 有备份保障

4. **兼容性好** ✅
   - V2.0 完全兼容 V1.0 数据库
   - 自动迁移和升级
   - 无需手动修改数据

### V2.0 的兼容性设计

我们在设计 V2.0 时特别考虑了向后兼容：

1. **数据库兼容** ✅
   - `database.py` 中的 `create_tables()` 会自动创建新表
   - 不会删除或修改现有表
   - 使用 `IF NOT EXISTS` 确保安全

2. **配置兼容** ✅
   - 新配置会自动初始化
   - 保留旧配置
   - 配置文件独立存储

3. **API 兼容** ✅
   - 所有旧 API 保持不变
   - 新 API 使用新路径
   - 不会影响现有功能

---

## 📋 增量更新详细步骤

### 阶段 1: 备份（5 分钟）

```bash
# 1. SSH 登录服务器
ssh root@your-server

# 2. 进入项目目录
cd /www/wwwroot/gendan

# 3. 备份数据库（重要！）
cd backend
python backup_db.py backup

# 4. 备份整个项目（可选但推荐）
cd /www/wwwroot
tar -czf gendan_backup_$(date +%Y%m%d_%H%M%S).tar.gz gendan/

# 备份文件会保存在 /www/wwwroot/gendan_backup_YYYYMMDD_HHMMSS.tar.gz
```

### 阶段 2: 拉取更新（2 分钟）

```bash
# 1. 进入项目目录
cd /www/wwwroot/gendan

# 2. 检查当前状态
git status

# 3. 如果有本地修改，先暂存
git stash

# 4. 拉取最新代码
git pull origin main

# 5. 如果之前有暂存，恢复（可选）
# git stash pop

# 6. 查看更新的文件
git log -1 --stat
```

### 阶段 3: 更新后端（5 分钟）

```bash
# 1. 进入后端目录
cd /www/wwwroot/gendan/backend

# 2. 激活虚拟环境
source venv/bin/activate

# 3. 更新依赖
pip install -r requirements.txt

# 4. 初始化数据库（会自动创建新表，不影响旧表）
python init_db.py

# 5. 初始化 AI 配置
python init_ai_config.py

# 6. 测试 AI 系统（可选）
python test_ai.py
```

### 阶段 4: 更新前端（3 分钟）

```bash
# 1. 进入前端目录
cd /www/wwwroot/gendan/frontend

# 2. 安装新依赖
npm install

# 3. 构建生产版本
npm run build

# 构建完成后，dist 目录会自动更新
```

### 阶段 5: 重启服务（2 分钟）

**在宝塔面板中操作**:

1. **重启后端**:
   - 找到 Python 项目管理
   - 找到 `gendan` 项目
   - 点击"重启"按钮

2. **检查日志**:
   - 查看项目日志
   - 确认启动成功
   - 查看是否有错误

3. **前端无需重启**（已经是静态文件）

### 阶段 6: 验证功能（5 分钟）

```bash
# 1. 检查健康状态
curl http://localhost:8000/health

# 应该返回:
# {
#   "status": "ok",
#   "version": "2.0.0",
#   "database": "connected",
#   "data_scheduler": "running",
#   "ai_scheduler": "running"
# }

# 2. 检查 API 文档
# 访问: http://kpl.17kx.net/docs
```

**前端验证**:
1. 访问 http://kpl.17kx.net
2. 登录系统（admin / admin888）
3. 检查新功能：
   - ✅ 系统监控页面 (http://kpl.17kx.net/system/monitor)
   - ✅ AI 分析页面 (http://kpl.17kx.net/ai/analysis)
4. 检查旧功能是否正常

---

## ⚠️ 如果选择全新部署（方案 B - 不推荐）

### 步骤概览

```bash
# 1. 备份数据
cd /www/wwwroot/gendan/backend
python backup_db.py backup
cp -r data /root/gendan_data_backup

# 2. 删除旧项目
cd /www/wwwroot
rm -rf gendan

# 3. 克隆新项目
git clone https://github.com/linlea666/hyperliquid-wallet-analyzer.git gendan

# 4. 恢复数据
cp -r /root/gendan_data_backup/* /www/wwwroot/gendan/backend/data/

# 5. 后续步骤同增量更新的阶段 3-6
```

**不推荐原因**:
- ❌ 耗时更长
- ❌ 需要重新配置宝塔
- ❌ 可能丢失配置文件
- ❌ 风险更高

---

## 🔄 回滚方案（如果出现问题）

### 快速回滚

```bash
# 1. 停止服务（在宝塔面板中）

# 2. 回滚代码
cd /www/wwwroot/gendan
git reset --hard HEAD~1

# 3. 恢复依赖
cd backend
source venv/bin/activate
pip install -r requirements.txt

# 4. 恢复数据库（如果需要）
python backup_db.py restore --file db_backup_YYYYMMDD_HHMMSS.db

# 5. 重启服务（在宝塔面板中）
```

### 完整回滚

```bash
# 1. 停止服务

# 2. 删除当前版本
cd /www/wwwroot
rm -rf gendan

# 3. 解压备份
tar -xzf gendan_backup_YYYYMMDD_HHMMSS.tar.gz

# 4. 重启服务
```

---

## 📝 部署检查清单

### 部署前

- [ ] 已备份数据库
- [ ] 已备份整个项目
- [ ] 已查看更新日志
- [ ] 已准备好 API Key
- [ ] 已通知用户（如有）

### 部署中

- [ ] 成功拉取代码
- [ ] 成功安装依赖
- [ ] 成功初始化数据库
- [ ] 成功初始化 AI 配置
- [ ] 成功构建前端
- [ ] 成功重启服务

### 部署后

- [ ] 健康检查通过
- [ ] 旧功能正常
- [ ] 新功能正常
- [ ] 系统监控正常
- [ ] AI 分析正常
- [ ] 无错误日志

---

## 🚨 常见问题处理

### 问题 1: 依赖安装失败

**症状**: `pip install` 报错

**解决**:
```bash
# 清理缓存
pip cache purge

# 升级 pip
pip install --upgrade pip

# 重新安装
pip install -r requirements.txt
```

### 问题 2: 数据库初始化失败

**症状**: `init_db.py` 报错

**解决**:
```bash
# 检查数据库文件权限
ls -la backend/data/

# 如果权限不对，修复
chmod 644 backend/data/hyperliquid_analyzer.db

# 重新初始化
python init_db.py
```

### 问题 3: AI 配置失败

**症状**: AI 功能不可用

**解决**:
```bash
# 重新初始化 AI 配置
python init_ai_config.py

# 检查配置
sqlite3 backend/data/hyperliquid_analyzer.db "SELECT * FROM system_configs WHERE config_key='ai';"
```

### 问题 4: 前端构建失败

**症状**: `npm run build` 报错

**解决**:
```bash
# 清理缓存
rm -rf node_modules package-lock.json

# 重新安装
npm install

# 重新构建
npm run build
```

### 问题 5: 服务启动失败

**症状**: 后端无法启动

**解决**:
```bash
# 查看详细日志
tail -f /www/wwwroot/gendan/backend/logs/app.log

# 检查端口占用
lsof -i:8000

# 如果端口被占用，杀死进程
kill -9 <PID>

# 重新启动
```

---

## 💡 最佳实践建议

### 1. 选择合适的时间

- ✅ 选择低峰时段（如凌晨）
- ✅ 提前通知用户
- ✅ 预留足够时间

### 2. 做好备份

- ✅ 数据库备份
- ✅ 项目备份
- ✅ 配置文件备份

### 3. 分步验证

- ✅ 每个步骤后验证
- ✅ 发现问题立即处理
- ✅ 记录所有操作

### 4. 保持冷静

- ✅ 遇到问题不要慌
- ✅ 参考文档和日志
- ✅ 必要时回滚

---

## 📞 技术支持

如遇到问题，请：

1. **查看日志**:
   - 后端日志: `/www/wwwroot/gendan/backend/logs/app.log`
   - 系统日志: 在日志管理页面查看

2. **参考文档**:
   - AI系统部署指南.md
   - 系统检查报告.md
   - 快速开始.md

3. **检查配置**:
   - 数据库配置
   - API 配置
   - Nginx 配置

---

## ✅ 推荐执行方案

**我强烈推荐使用增量更新（方案 A）**，原因如下：

1. **安全**: 保留所有现有数据
2. **快速**: 15-20 分钟完成
3. **可靠**: 可以随时回滚
4. **简单**: 步骤清晰明了

**执行顺序**:
1. 备份（5 分钟）
2. 拉取更新（2 分钟）
3. 更新后端（5 分钟）
4. 更新前端（3 分钟）
5. 重启服务（2 分钟）
6. 验证功能（5 分钟）

**总耗时**: 约 20-25 分钟

---

**准备好开始了吗？** 🚀

建议按照上述"增量更新详细步骤"逐步执行。

---

**文档版本**: 1.0  
**作者**: AI Assistant  
**日期**: 2025-11-22

