# 通知系统测试指南

## 📋 测试前准备

### 1. 启动后端服务

```bash
cd backend
source venv/bin/activate
python app/main.py
```

确保服务运行在 `http://localhost:8000`

### 2. 配置邮件服务（可选）

如果要测试邮件功能，需要先配置邮件服务：

#### 方式一：通过前端配置（推荐）

1. 访问 http://localhost:5173
2. 登录系统（admin/admin888）
3. 进入 **系统管理 → 系统配置 → 通知配置**
4. 启用邮件通知并填写配置：
   - SMTP 服务器: `smtp.163.com`
   - SMTP 端口: `465`
   - 发件人邮箱: `your@163.com`
   - 邮箱密码: 使用**授权码**（非登录密码）
   - 收件人: 添加测试邮箱
5. 点击"发送测试邮件"验证配置

#### 方式二：直接修改数据库

```bash
cd backend
python -c "
from app.database import db
import json

config = {
    'email': {
        'enabled': True,
        'smtp_host': 'smtp.163.com',
        'smtp_port': 465,
        'use_ssl': True,
        'sender_email': 'your@163.com',
        'sender_password': '授权码',
        'recipients': ['test@example.com']
    },
    'rules': {
        'importComplete': True,
        'highScoreWallet': True,
        'highScoreThreshold': 80,
        'abnormalTrade': True,
        'systemError': True
    }
}

db.execute('''
    INSERT OR REPLACE INTO system_configs (config_key, config_value, updated_at)
    VALUES (?, ?, datetime('now'))
''', ('notification', json.dumps(config)))

print('✅ 配置已保存')
"
```

### 3. 获取 163 邮箱授权码

1. 登录 163 邮箱
2. 设置 → POP3/SMTP/IMAP
3. 开启 SMTP 服务
4. 获取授权码（不是登录密码！）

---

## 🧪 运行测试

### 方式一：使用测试脚本（推荐）

```bash
cd backend
python test_notification.py
```

测试菜单：
```
1. 测试邮件配置      - 检查配置是否正确
2. 发送测试邮件      - 发送一封测试邮件
3. 查看邮件历史      - 查看最近的发送记录
4. 查看邮件统计      - 查看发送统计信息
5. 测试通知发送      - 测试通知系统
6. 查看通知规则      - 查看当前规则配置
7. 查看通知列表      - 查看系统通知
8. 测试所有通知类型  - 测试 4 种通知类型
9. 运行完整测试      - 运行所有测试项
0. 退出
```

### 方式二：使用 API 测试

#### 1. 获取 Token

```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin888"
  }'
```

保存返回的 `access_token`

#### 2. 发送测试邮件

```bash
curl -X POST http://localhost:8000/api/notifications/test-email \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "config": {
      "enabled": true,
      "smtp_host": "smtp.163.com",
      "smtp_port": 465,
      "use_ssl": true,
      "sender_email": "your@163.com",
      "sender_password": "授权码",
      "recipients": ["test@example.com"]
    }
  }'
```

#### 3. 查看邮件历史

```bash
curl -X GET http://localhost:8000/api/notifications/email/history \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 4. 查看邮件统计

```bash
curl -X GET http://localhost:8000/api/notifications/email/statistics \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5. 获取通知列表

```bash
curl -X GET "http://localhost:8000/api/notifications?limit=10&is_read=false" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ✅ 测试检查清单

### 邮件服务测试

- [ ] 邮件配置正确加载
- [ ] 测试邮件发送成功
- [ ] 收到测试邮件（检查收件箱和垃圾邮件）
- [ ] 邮件格式正确（HTML 显示正常）
- [ ] 发送历史记录正确
- [ ] 统计信息准确

### 通知系统测试

- [ ] 通知规则正确加载
- [ ] WebSocket 通知推送成功
- [ ] 数据库通知保存成功
- [ ] 邮件通知发送成功（如已配置）
- [ ] 频率限制生效
- [ ] 通知列表查询正常
- [ ] 未读数量正确
- [ ] 标记已读功能正常
- [ ] 删除通知功能正常

### 通知类型测试

- [ ] 导入完成通知
  - WebSocket 推送 ✓
  - 邮件发送 ✓
  - 数据库存储 ✓
  - 模板显示正确 ✓

- [ ] 高分钱包通知
  - WebSocket 推送 ✓
  - 邮件发送 ✓
  - 数据库存储 ✓
  - 模板显示正确 ✓

- [ ] 异常交易通知
  - WebSocket 推送 ✓
  - 邮件发送 ✓
  - 数据库存储 ✓

- [ ] 系统错误通知
  - WebSocket 推送 ✓
  - 邮件发送 ✓
  - 数据库存储 ✓

---

## 🐛 常见问题

### 1. 邮件发送失败

**问题**: `SMTPAuthenticationError: 535 Error`

**解决**:
- 确认使用的是**授权码**而不是登录密码
- 检查 163 邮箱是否开启了 SMTP 服务
- 确认邮箱地址正确

**问题**: `Connection refused`

**解决**:
- 检查网络连接
- 确认 SMTP 端口正确（465 或 25）
- 检查防火墙设置

### 2. 配置未生效

**问题**: 修改配置后没有生效

**解决**:
```python
# 重新加载配置
from app.services.notification import email_service, notification_manager

email_service.reload_config()
notification_manager.reload_rules()
```

### 3. 收不到邮件

**检查**:
- 垃圾邮件箱
- 邮箱设置是否拦截
- 发送历史中的错误信息
- SMTP 日志

### 4. 通知未推送

**检查**:
- WebSocket 是否连接
- 通知规则是否启用
- 频率限制是否触发
- 后端日志错误信息

---

## 📊 测试结果示例

### 成功的测试输出

```
============================================================
  1. 测试邮件配置
============================================================
✓ 邮件服务启用: True
✓ SMTP 服务器: smtp.163.com
✓ SMTP 端口: 465
✓ 发件人: your@163.com
✓ 收件人数量: 1

============================================================
  2. 测试邮件发送
============================================================
📧 准备发送测试邮件...
✅ 测试邮件发送成功！
   请检查收件箱（包括垃圾邮件）

============================================================
  3. 测试邮件历史
============================================================
✓ 历史记录数量: 1

最近 5 条记录:

1. ✅ HyperLiquid 钱包分析系统 - 测试邮件
   收件人: test@example.com
   时间: 2025-11-22 10:00:00
   状态: sent

============================================================
  4. 测试邮件统计
============================================================
✓ 总发送数: 1
✓ 成功数: 1
✓ 失败数: 0
✓ 今日发送: 1
✓ 成功率: 100.0%

============================================================
  5. 测试通知发送
============================================================
📢 测试发送导入完成通知...
✅ 通知发送成功
   - WebSocket 推送: ✓
   - 数据库存储: ✓
   - 邮件发送: ✓
```

---

## 🎯 下一步

测试通过后，可以：

1. **集成到实际业务**
   - 在导入完成时自动发送通知
   - 在发现高分钱包时自动通知
   - 在系统错误时自动告警

2. **配置生产环境**
   - 使用正式邮箱
   - 配置正确的收件人
   - 调整通知规则

3. **监控和优化**
   - 查看发送统计
   - 分析失败原因
   - 优化邮件模板

---

## 📞 技术支持

如有问题，请查看：
- 后端日志: `backend/logs/app.log`
- 数据库: `backend/data/hyperliquid_analyzer.db`
- API 文档: http://localhost:8000/docs

---

*测试指南版本: V2.0*
*更新时间: 2025-11-22*

