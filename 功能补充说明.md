# 功能补充说明

## 📋 本次补充的功能

根据您的反馈，已补充和完善以下功能：

---

## 1. 存款取款功能 ✅

### 1.1 API 集成
- ✅ 获取钱包存款记录（Deposit History）
- ✅ 获取钱包取款记录（Withdraw History）
- ✅ 解析存款取款数据
- ✅ 增量更新存款取款记录

### 1.2 数据模型更新
- ✅ 钱包数据中添加 `deposits` 和 `withdrawals` 字段
- ✅ 添加 `initial_capital`（初始资金）计算
- ✅ 添加 `total_deposits`（累计存款）
- ✅ 添加 `total_withdrawals`（累计取款）
- ✅ 添加 `net_deposits`（净存款）

### 1.3 初始资金计算
- **计算公式**：`初始资金 = 累计存款 - 累计取款`
- **用途**：用于准确计算 ROI（基于初始资金而非当前余额）
- **更新机制**：每次有新的存款/取款时重新计算

### 1.4 钱包时间计算
- **钱包创建时间**（`wallet_created_time`）：
  - 基于第一笔存款时间
  - 用于判断钱包最早活动时间
  
- **第一笔合约开仓时间**（`first_trade_time`）：
  - 基于第一笔合约交易时间
  - **用于计算钱包年龄**（wallet_age_days）
  - **用于筛选**（如"1-6个月小资金"筛选）

### 1.5 钱包详情页展示
- ✅ 存款记录表格（时间、金额、交易哈希、状态）
- ✅ 取款记录表格（时间、金额、交易哈希、状态）
- ✅ 资金流水统计（累计存款/取款/净存款）
- ✅ 资金流向图（存款取款时间线）
- ✅ 余额变化曲线（包含存款取款影响）

---

## 2. 可视化看板页面（Dashboard）✅

### 2.1 页面位置
- 新增独立页面，可通过导航栏访问
- 可选作为默认首页

### 2.2 核心功能模块

#### 2.2.1 总体统计卡片
- 钱包总数
- 总资产规模
- 总盈亏
- 平均 ROI
- 平均胜率
- 活跃钱包数（最近24小时）

#### 2.2.2 多空比统计
- **整体多空比**：
  - 多头持仓总价值 vs 空头持仓总价值
  - 饼图/柱状图可视化
  - 多空比例数值显示
  
- **按币种多空比**：
  - BTC/ETH/其他币种的多空分布
  - 横向对比图表
  
- **多空盈亏对比**：
  - 多头总盈亏 vs 空头总盈亏
  - 趋势对比图

#### 2.2.3 合约方向统计
- 持仓方向分布（各币种多/空）
- 交易方向统计（历史多单 vs 空单）
- 方向偏好分析（多头偏好/空头偏好/平衡型钱包数）

#### 2.2.4 资金数据统计
- **资金规模分布**：
  - 小资金（< $1000）/ 中等资金（$1000-$5000）/ 大资金（> $5000）
  - 饼图/柱状图展示
  
- **资金流向统计**：
  - 最近24小时/7天/30天总存款
  - 最近24小时/7天/30天总取款
  - 净资金流入/流出趋势图
  
- **初始资金分布**：
  - 各初始资金区间的钱包数量
  - 初始资金与 ROI 的关系散点图

#### 2.2.5 爆仓信息统计
- **爆仓统计卡片**：
  - 总爆仓次数
  - 爆仓钱包数
  - 爆仓率
  
- **爆仓时间线**：
  - 最近爆仓记录列表
  - 显示钱包地址、币种、爆仓时间、损失金额
  
- **爆仓分析**：
  - 爆仓原因分析
  - 爆仓币种分布
  - 爆仓时间分布（热力图）

#### 2.2.6 钱包异动监控 ⭐
- **大额交易异动**：
  - 最近24小时大额交易列表
  - 筛选条件：交易金额 > 阈值（可配置，默认 $10000）
  - 显示：钱包地址、币种、方向、金额、时间
  - 支持按金额/时间排序
  
- **大额存取款异动**：
  - 最近24小时大额存款列表（金额 > 阈值）
  - 最近24小时大额取款列表（金额 > 阈值）
  - 显示：钱包地址、金额、时间、交易哈希
  - 异动趋势图（时间线）
  
- **异常行为检测**：
  - 突然大额盈利/亏损（超过阈值）
  - 交易频率异常（突然增加/减少）
  - 持仓方向突然改变
  - 杠杆率异常变化

#### 2.2.7 排行榜
- Top 10 盈利钱包
- Top 10 ROI 钱包
- Top 10 Smart Money Score 钱包
- Top 10 交易次数最多的钱包
- Top 10 交易频率最高的钱包

#### 2.2.8 趋势图表
- 整体收益趋势（所有钱包总收益曲线）
- 多空比趋势（多空比例随时间变化）
- 资金流入流出趋势（存款取款净流量）

#### 2.2.9 实时更新
- 看板数据自动刷新（可配置刷新间隔，默认30秒）
- 手动刷新按钮
- 数据更新时间显示

---

## 3. 通知提醒系统 ✅

### 3.1 通知类型

#### 3.1.1 收益提醒
- 钱包收益达到设定阈值（可配置）
- 钱包 ROI 达到设定阈值
- 钱包单笔交易盈利超过阈值

#### 3.1.2 风险提醒
- 钱包爆仓提醒
- 钱包最大回撤超过阈值
- 钱包余额低于阈值（接近爆仓）
- 钱包杠杆率过高

#### 3.1.3 异动提醒 ⭐
- **大额交易提醒**（交易金额 > 阈值）
- **大额存款提醒**（存款金额 > 阈值）
- **大额取款提醒**（取款金额 > 阈值）
- 交易频率异常提醒
- 持仓方向突然改变提醒

#### 3.1.4 系统提醒
- 钱包数据更新失败提醒
- API 调用异常提醒
- 系统错误提醒

### 3.2 通知方式

#### 3.2.1 浏览器推送通知 ✅
- 使用 Web Notification API
- 需要用户授权
- 支持桌面通知（即使浏览器关闭也能收到）
- **通知内容**：
  - 标题：通知类型（如"大额交易提醒"）
  - 内容：简要信息（如"钱包 0x1234... 发生大额交易 $50000"）
  - 图标：钱包头像或系统图标
  - 点击跳转：跳转到对应钱包详情页
- **通知设置**：
  - 开启/关闭浏览器通知
  - 设置通知声音
  - 设置通知持续时间

#### 3.2.2 邮件通知 ✅
- 使用 SMTP 发送邮件
- 支持配置邮件服务器（Gmail/QQ邮箱/自定义SMTP）
- **邮件内容**：
  - 主题：通知类型和钱包地址
  - 正文：详细信息（HTML格式）
    - 钱包地址和头像
    - 事件详情
    - 相关数据（金额、时间等）
    - 跳转链接
- **邮件设置**：
  - 开启/关闭邮件通知
  - 配置 SMTP 服务器
  - 设置发件人邮箱和密码
  - 设置收件人邮箱（可多个）
  - 设置邮件发送频率（立即/每小时汇总/每天汇总）

### 3.3 通知配置

#### 3.3.1 全局通知设置
配置文件：`config/notifications.json`

```json
{
  "enabled": true,
  "browser": {
    "enabled": true,
    "sound": true,
    "duration": 5000
  },
  "email": {
    "enabled": false,
    "smtp": {
      "host": "smtp.gmail.com",
      "port": 587,
      "username": "",
      "password": "",
      "from_email": "",
      "to_emails": []
    },
    "frequency": "immediate"
  },
  "thresholds": {
    "large_trade": 10000,
    "large_deposit": 5000,
    "large_withdrawal": 5000,
    "profit_threshold": 5000,
    "roi_threshold": 200,
    "drawdown_threshold": 50
  }
}
```

#### 3.3.2 钱包级别通知设置
- 每个钱包可单独设置通知规则
- 可选择关注的钱包（只接收关注钱包的通知）
- 可设置钱包特定的阈值

### 3.4 通知历史
- 通知记录存储（`data/notifications.json`）
- 通知历史页面：
  - 显示所有历史通知
  - 支持筛选（按类型/时间/钱包）
  - 支持标记已读/未读
  - 支持删除通知
- 通知统计：
  - 今日通知数
  - 未读通知数
  - 各类型通知数量

### 3.5 通知实现
- **后端**：
  - 定时检查钱包数据变化
  - 触发通知条件时生成通知
  - 发送浏览器推送（通过 WebSocket）
  - 发送邮件通知
  - 记录通知历史
  
- **前端**：
  - 请求浏览器通知权限
  - 接收 WebSocket 通知消息
  - 显示浏览器通知
  - 通知中心（显示历史通知）

---

## 4. 筛选功能增强 ✅

### 4.1 钱包年龄筛选
- **计算方式**：基于第一笔合约开仓时间（`first_trade_time`）
- **筛选选项**：
  - 1个月
  - 3个月
  - 6个月
  - 1年
  - 全部
- **默认筛选**：1-6个月（用于"潜力钱包推荐"）

### 4.2 初始资金筛选
- 基于存款取款计算的初始资金
- 筛选范围：$0 到 $10000（可配置）

---

## 5. 数据模型更新总结

### 5.1 钱包数据模型新增字段

```json
{
  "metadata": {
    "first_trade_time": "2024-01-01T00:00:00Z",  // 第一笔合约开仓时间
    "wallet_created_time": "2024-01-01T00:00:00Z"  // 钱包创建时间（第一笔存款时间）
  },
  "metrics": {
    "initial_capital": 2000,  // 初始资金（累计存款 - 累计取款）
    "total_deposits": 5000,  // 累计存款
    "total_withdrawals": 3000,  // 累计取款
    "net_deposits": 2000  // 净存款（存款 - 取款）
  },
  "deposits": [...],  // 存款记录
  "withdrawals": [...]  // 取款记录
}
```

---

## 6. API 更新总结

### 6.1 新增 API 端点

#### 看板相关
- `GET /api/dashboard/stats` - 获取看板统计数据
- `GET /api/dashboard/long-short-ratio` - 获取多空比数据
- `GET /api/dashboard/anomalies` - 获取异动数据
- `GET /api/dashboard/rankings` - 获取排行榜数据

#### 通知相关
- `GET /api/notifications` - 获取通知列表
- `POST /api/notifications/mark-read` - 标记通知已读
- `DELETE /api/notifications/{id}` - 删除通知
- `GET /api/notifications/settings` - 获取通知设置
- `PUT /api/notifications/settings` - 更新通知设置

#### 存款取款相关
- `GET /api/wallets/{address}/deposits` - 获取存款记录
- `GET /api/wallets/{address}/withdrawals` - 获取取款记录

---

## 7. 前端页面更新

### 7.1 新增页面
- `Dashboard.vue` - 可视化看板页面
- `Notifications.vue` - 通知中心页面

### 7.2 更新页面
- `WalletDetail.vue` - 添加存款取款记录展示
- `WalletList.vue` - 更新筛选条件（钱包年龄、初始资金）

---

## 8. 配置文件更新

### 8.1 新增配置
- `config/notifications.json` - 通知系统配置

### 8.2 更新配置
- `config/filters.json` - 添加钱包年龄和初始资金筛选配置

---

## 9. 技术实现要点

### 9.1 初始资金计算
```python
def calculate_initial_capital(deposits, withdrawals):
    """计算初始资金"""
    total_deposits = sum(d['amount'] for d in deposits)
    total_withdrawals = sum(w['amount'] for w in withdrawals)
    return total_deposits - total_withdrawals
```

### 9.2 钱包年龄计算
```python
def calculate_wallet_age(first_trade_time):
    """计算钱包年龄（基于第一笔合约开仓时间）"""
    if not first_trade_time:
        return 0
    delta = datetime.now() - first_trade_time
    return delta.days
```

### 9.3 ROI 计算更新
```python
def calculate_roi(total_pnl, initial_capital):
    """计算 ROI（基于初始资金）"""
    if initial_capital == 0:
        return 0
    return (total_pnl / initial_capital) * 100
```

### 9.4 异动检测
```python
def detect_anomalies(wallet, previous_state):
    """检测钱包异动"""
    anomalies = []
    
    # 检测大额交易
    if wallet.latest_trade_amount > threshold:
        anomalies.append({
            'type': 'large_trade',
            'amount': wallet.latest_trade_amount,
            'time': wallet.latest_trade_time
        })
    
    # 检测大额存款
    if wallet.latest_deposit_amount > threshold:
        anomalies.append({
            'type': 'large_deposit',
            'amount': wallet.latest_deposit_amount,
            'time': wallet.latest_deposit_time
        })
    
    # 检测交易频率异常
    if wallet.trade_frequency > previous_state.trade_frequency * 2:
        anomalies.append({
            'type': 'frequency_anomaly',
            'current': wallet.trade_frequency,
            'previous': previous_state.trade_frequency
        })
    
    return anomalies
```

---

## 10. 总结

### ✅ 已补充的功能
1. **存款取款功能**：完整的存款取款记录获取、展示和分析
2. **初始资金计算**：基于存款取款准确计算初始资金
3. **钱包年龄计算**：基于第一笔合约开仓时间
4. **可视化看板**：全面的数据统计和可视化展示
5. **钱包异动监控**：大额交易、存取款、异常行为检测
6. **通知提醒系统**：浏览器推送 + 邮件通知
7. **通知配置**：全局和钱包级别的通知设置

### 📊 数据准确性提升
- ROI 计算更准确（基于初始资金）
- 钱包年龄筛选更准确（基于第一笔合约开仓时间）
- 资金流向分析更完整（包含存款取款）

### 🎯 用户体验提升
- 看板页面提供全局视角
- 异动监控及时发现重要事件
- 通知提醒不错过关键信息

---

**所有功能已规划完成，等待确认后开始编码实现！**

