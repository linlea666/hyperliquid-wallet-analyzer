# HyperLiquid API 集成分析

## API 需求对比

### ✅ 可以满足的需求

#### 1. 交易历史（Fills）
- **API**: `userFills` 和 `userFillsByTime`
- **功能**: 获取用户成交记录
- **限制**: 
  - `userFills`: 最多2000条最近记录
  - `userFillsByTime`: 每次最多2000条，总共最多10000条可用
- **数据包含**:
  - 币种、方向、价格、数量
  - 盈亏（closedPnl）
  - 手续费（fee）
  - 时间戳（time）
  - 交易哈希（hash）
- **✅ 完全满足需求**

#### 2. 账户价值历史
- **API**: `portfolio`
- **功能**: 获取账户价值历史和盈亏历史
- **数据包含**:
  - accountValueHistory（账户价值历史）
  - pnlHistory（盈亏历史）
  - 支持多个时间范围：day/week/month/allTime
- **✅ 可以用于生成收益曲线**

#### 3. 当前挂单
- **API**: `openOrders` 或 `frontendOpenOrders`
- **功能**: 获取当前挂单
- **✅ 可以显示当前订单状态**

#### 4. 历史订单
- **API**: `historicalOrders`
- **功能**: 获取历史订单（最多2000条）
- **✅ 可以补充交易历史**

### ⚠️ 部分满足的需求

#### 1. 当前持仓
- **问题**: 文档中没有直接的持仓 API
- **解决方案**:
  - 可以通过 `portfolio` API 获取账户价值
  - 可能需要通过 `openOrders` 推断持仓
  - 或者通过分析 `userFills` 计算持仓
- **⚠️ 需要额外处理**

#### 2. 存款/取款记录
- **问题**: 文档中没有直接的存款/取款 API
- **解决方案**:
  - 通过链上数据获取（需要额外的链上查询）
  - 或者通过账户价值变化推断（不准确）
  - 或者通过 `portfolio` 的账户价值变化分析
- **⚠️ 需要额外实现或使用链上数据**

### ❌ 无法满足的需求

#### 1. 详细的存款/取款记录
- **问题**: API 不提供存款/取款记录
- **影响**: 无法准确计算初始资金
- **解决方案**: 
  - 使用链上数据（需要集成 Web3 查询）
  - 或者通过账户价值历史推断（不准确）
  - 或者让用户手动输入初始资金

## 实现策略

### 方案一：完全基于 API（推荐用于 MVP）

**优点**:
- 实现简单
- 不需要链上查询
- 快速上线

**缺点**:
- 无法获取存款/取款记录
- 初始资金需要估算或用户输入

**实现**:
1. 使用 `userFills` 获取交易历史
2. 使用 `portfolio` 获取账户价值历史
3. 通过账户价值历史推断初始资金（最早的价值）
4. 使用 `openOrders` 获取当前挂单

### 方案二：API + 链上数据（完整方案）

**优点**:
- 数据完整准确
- 可以获取存款/取款记录

**缺点**:
- 实现复杂
- 需要 Web3 集成
- 查询链上数据可能较慢

**实现**:
1. 使用 API 获取交易数据
2. 使用 Web3 查询链上存款/取款记录
3. 结合两者计算完整数据

## 推荐实现方案

**当前阶段推荐方案一**，原因：
1. 快速实现 MVP
2. API 数据已经足够分析交易行为
3. 初始资金可以通过账户价值历史估算
4. 后续可以扩展链上数据查询

## API 调用示例

### 获取交易历史
```python
# 获取最近2000条成交记录
{
    "type": "userFills",
    "user": "0x..."
}

# 按时间范围获取（用于增量更新）
{
    "type": "userFillsByTime",
    "user": "0x...",
    "startTime": 1234567890000,
    "endTime": 1234567890000
}
```

### 获取账户价值历史
```python
{
    "type": "portfolio",
    "user": "0x..."
}
```

### 获取当前挂单
```python
{
    "type": "openOrders",
    "user": "0x..."
}
```

## 注意事项

1. **分页处理**: 
   - `userFillsByTime` 每次最多2000条
   - 需要循环调用直到获取所有数据
   - 使用返回的最后时间戳作为下一次的 startTime

2. **时间范围限制**:
   - `userFillsByTime` 最多返回10000条最近记录
   - 对于历史较长的钱包，可能需要多次查询

3. **数据格式**:
   - 时间戳是毫秒级（milliseconds）
   - 价格和数量是字符串格式
   - 需要转换为数字进行计算

4. **币种格式**:
   - 永续合约：直接使用币种名（如 "BTC"）
   - Spot：使用 `@{index}` 格式（如 "@107"）

5. **方向判断**:
   - `dir` 字段：如 "Open Long", "Close Long", "Sell" 等
   - `side` 字段：A/B 表示买卖方向

## 总结

✅ **API 可以满足大部分需求**：
- 交易历史 ✅
- 账户价值历史 ✅
- 当前挂单 ✅
- 历史订单 ✅

⚠️ **需要额外处理**：
- 当前持仓（需要计算）
- 存款/取款记录（需要链上数据或估算）

❌ **无法直接获取**：
- 详细的存款/取款记录（需要链上查询）

**建议**: 先实现方案一，后续根据需求扩展链上数据查询功能。

